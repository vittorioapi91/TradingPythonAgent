pipeline {
    agent any
    
    // This pipeline only runs when .ops directory changes
    // It validates and builds infra-platform components (Airflow, Grafana, etc.)
    
    stages {
        stage('Check if .ops Changed') {
            steps {
                script {
                    // Check if .ops/ directory has changes
                    def changedFiles = sh(
                        script: 'git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only origin/${GIT_BRANCH} 2>/dev/null || echo ""',
                        returnStdout: true
                    ).trim()
                    
                    def hasOpsChanges = false
                    if (changedFiles) {
                        changedFiles.split('\n').each { file ->
                            if (file.startsWith('.ops/')) {
                                hasOpsChanges = true
                            }
                        }
                    }
                    
                    if (!hasOpsChanges) {
                        echo "⚠️  No .ops/ directory changes detected. Skipping infra-platform pipeline."
                        currentBuild.result = 'ABORTED'
                        error("Pipeline aborted: No infrastructure changes detected")
                    }
                    
                    echo "✓ .ops/ directory changes detected. Proceeding with infra-platform validation."
                }
            }
        }
        
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Validate Infra-Platform Configuration') {
            steps {
                script {
                    echo "Validating infra-platform configuration..."
                    sh """
                        # Validate docker-compose files
                        if [ -f ".ops/.docker/docker-compose.infra-platform.yml" ]; then
                            echo "Validating docker-compose.infra-platform.yml..."
                            docker-compose -f .ops/.docker/docker-compose.infra-platform.yml config > /dev/null || {
                                echo "❌ docker-compose.infra-platform.yml is invalid"
                                exit 1
                            }
                            echo "✓ docker-compose.infra-platform.yml is valid"
                        fi
                        
                        if [ -f ".ops/.docker/docker-compose.yml" ]; then
                            echo "Validating docker-compose.yml..."
                            docker-compose -f .ops/.docker/docker-compose.yml config > /dev/null || {
                                echo "❌ docker-compose.yml is invalid"
                                exit 1
                            }
                            echo "✓ docker-compose.yml is valid"
                        fi
                        
                        # Validate Airflow DAGs (if they exist)
                        if [ -d ".ops/.airflow/dags" ]; then
                            echo "Validating Airflow DAGs..."
                            # Create minimal venv for DAG validation
                            python3 -m venv /tmp/infra_venv || true
                            /tmp/infra_venv/bin/pip install --quiet apache-airflow tqdm pandas psycopg2-binary requests python-dotenv || true
                            
                            export AIRFLOW_HOME=/tmp/airflow_infra_home
                            export AIRFLOW__CORE__DAGS_FOLDER=.ops/.airflow/dags
                            export AIRFLOW__CORE__LOAD_EXAMPLES=False
                            export AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=sqlite:////tmp/airflow_infra_home/airflow.db
                            
                            mkdir -p \${AIRFLOW_HOME}
                            /tmp/infra_venv/bin/python -m airflow db migrate 2>/dev/null || true
                            /tmp/infra_venv/bin/python -m airflow dags list > /dev/null 2>&1 && {
                                echo "✓ Airflow DAGs are valid"
                            } || {
                                echo "⚠️  Warning: Could not validate Airflow DAGs (may need full Airflow setup)"
                            }
                        fi
                        
                        echo "✓ Infra-platform configuration validated"
                    """
                }
            }
        }
        
        stage('Build Infra-Platform Images') {
            steps {
                script {
                    echo "Building infra-platform Docker images..."
                    sh """
                        # Build Jenkins custom image if Dockerfile exists
                        if [ -f ".ops/.docker/Dockerfile.jenkins" ]; then
                            echo "Building jenkins-custom:lts image..."
                            docker build -f .ops/.docker/Dockerfile.jenkins -t jenkins-custom:lts .ops/.docker/ || {
                                echo "⚠️  Warning: Could not build Jenkins image"
                            }
                        fi
                        
                        echo "✓ Infra-platform images built (or using pre-built images)"
                    """
                }
            }
        }
        
        stage('Validate Infra-Platform Services') {
            steps {
                script {
                    echo "Validating infra-platform services can start..."
                    sh """
                        # Test that docker-compose files are valid and services can be checked
                        if [ -f ".ops/.docker/docker-compose.infra-platform.yml" ]; then
                            echo "Checking infra-platform services..."
                            docker-compose -f .ops/.docker/docker-compose.infra-platform.yml config --services | head -10
                            echo "✓ Infra-platform services configuration is valid"
                        fi
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo "✓ Infra-platform pipeline succeeded!"
        }
        failure {
            echo "✗ Infra-platform pipeline failed. Check logs for details."
        }
    }
}
